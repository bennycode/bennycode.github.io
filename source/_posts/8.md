---
title: TypeScript code coverage with Karma
date: 2019/4/29 16:53:35
categories:
  - [TypeScript, Setup]
tags:
  - karma
  - webpack
  - babel
  - typescript
  - istanbul
  - coverage
---

## Baseline

- Node.js v10.9.0
- yarn v1.15.2

{% codeblock lang:json package.json %}
{
  "devDependencies": {
    "jasmine": "3.4.0"
  },
  "main": "src/main.js",
  "name": "karma-webpack-babel-typescript-istanbul",
  "scripts": {
    "start": "node index.js",
    "test": "jasmine --config=jasmine.json"
  },
  "version": "0.0.0"
}
{% endcodeblock %}

{% codeblock lang:json jasmine.json %}
{
  "random": true,
  "spec_dir": "src",
  "spec_files": [
    "**/*test.js"
  ],
  "stopSpecOnExpectationFailure": true
}
{% endcodeblock %}

{% codeblock lang:js index.js %}
const afterTwoSeconds = require('./src/main');

afterTwoSeconds(() => {
  console.log('I will be called after 2 seconds.');
});
{% endcodeblock %}

{% codeblock lang:js src/main.js %}
module.exports = function afterTwoSeconds(callback) {
  return new Promise((resolve) => {
    setTimeout(() => {
      callback();
      resolve();
    }, 2000);
  });
};
{% endcodeblock %}

{% codeblock lang:js src/main.test.js %}
const afterTwoSeconds = require('./main');

describe('afterTwoSeconds', () => {
  it('resolves after 2 seconds', async () => {
    const myCallbackSpy = jasmine.createSpy('myCallbackSpy');
    await afterTwoSeconds(myCallbackSpy);
    expect(myCallbackSpy).toHaveBeenCalled();
  });
});
{% endcodeblock %}

## Add Karma

{% codeblock lang:json mark:4-6,12 package.json %}
{
  "devDependencies": {
    "jasmine": "3.4.0",
    "karma": "4.1.0",
    "karma-chrome-launcher": "2.2.0",
    "karma-jasmine": "2.0.1"
  },
  "main": "src/main.js",
  "name": "karma-webpack-babel-typescript-istanbul",
  "scripts": {
    "start": "node index.js",
    "test": "karma start"
  },
  "version": "0.0.0"
}
{% endcodeblock %}

{% codeblock lang:js mark:10-14 src/main.js %}
function afterTwoSeconds(callback) {
  return new Promise((resolve) => {
    setTimeout(() => {
      callback();
      resolve();
    }, 2000);
  });
}

if (typeof module !== 'undefined' && typeof module.exports !== 'undefined') {
  module.exports = afterTwoSeconds;
} else {
  window.afterTwoSeconds = afterTwoSeconds;
}
{% endcodeblock %}

{% codeblock lang:js mark:4 src/main.test.js %}
describe('afterTwoSeconds', () => {
  it('resolves after 2 seconds', async () => {
    const myCallbackSpy = jasmine.createSpy('myCallbackSpy');
    await window.afterTwoSeconds(myCallbackSpy);
    expect(myCallbackSpy).toHaveBeenCalled();
  });
});
{% endcodeblock %}

{% codeblock lang:js karma.conf.js %}
const jasmineConfig = require('./jasmine');

module.exports = function (config) {
  config.set({
    autoWatch: false,
    basePath: jasmineConfig.spec_dir,
    browsers: ['Chrome'],
    colors: true,
    concurrency: Infinity,
    exclude: [],
    files: [
      'main.js',
      ...jasmineConfig.spec_files
    ],
    frameworks: ['jasmine'],
    logLevel: config.LOG_INFO,
    port: 9876,
    preprocessors: {},
    reporters: ['progress'],
    singleRun: true,
  });
};
{% endcodeblock %}

## Add Webpack

...